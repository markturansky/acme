# bin/monitor-health Requirements

## Purpose

The `health-check` script generates comprehensive status reports for all clusters and components in the OpenShift Bootstrap environment, creating a detailed `STATUS.md` file with real-time health information.

## Functional Requirements

### Connection Validation
- **Hub Cluster Authentication**: Must verify connection to hub cluster via `oc whoami`
- **Context Information**: Display current cluster context for confirmation
- **Exit on Failure**: Must exit with error code 1 if not authenticated

### Cluster Discovery
- **Cluster List Generation**: Discover clusters from `gitops-applications/cluster-*.yaml` files
- **Naming Pattern**: Must support `cluster-XX` numbering pattern
- **Sorted Output**: Present clusters in sorted order for consistency

### Status Report Generation

#### Hub Cluster Components
Must check and report status for:
- **ArgoCD GitOps**: OpenShift GitOps server deployment status and application count
- **ACM MultiClusterHub**: MultiClusterHub phase and availability
- **Managed Clusters Summary**: Total clusters and availability count

#### Per-Cluster Status
For each discovered cluster, must report:
- **Cluster Provisioning**: OCP (Hive) or EKS (CAPI) cluster readiness
- **ACM Management**: ManagedCluster availability status
- **ArgoCD Applications**: Application sync and health status

### Output Requirements

#### STATUS.md File Structure
```markdown
# OpenShift Bootstrap Cluster Status

**Last Updated:** [timestamp]
**Generated by:** `bin/monitor-health` script

## Hub Cluster Status
### ArgoCD GitOps
### ACM MultiClusterHub
### Managed Clusters Summary

## Cluster Status Details
### cluster-XX
#### Cluster Provisioning
#### ACM Management
#### ArgoCD Applications

## Quick Commands
## Context for Claude Re-evaluation
```

#### Status Indicators
- ✅ **Ready/Available**: Component is operational
- ⏳ **Not Ready/Progressing**: Component is provisioning
- ❌ **Failed/Not Found**: Component has issues or doesn't exist

### Health Check Logic

#### Cluster Provisioning Detection
- **Hive ClusterDeployment**: Check `ClusterReadyCondition` status
- **CAPI Cluster**: Check `Ready` condition status
- **Fallback**: Report "Resources not found" if neither exists

#### ACM Management Verification
- **ManagedCluster**: Check `ManagedClusterConditionAvailable` status
- **Status Reporting**: Include actual status value for troubleshooting

#### ArgoCD Application Assessment
- **Application Discovery**: Find applications matching `cluster-XX-*` pattern
- **Sync Status**: Count synced vs total applications
- **Individual Status**: Report sync and health status per application

### Error Handling Requirements

#### Connection Failures
- **Clear Messaging**: "Not connected to hub cluster. Please run: oc login"
- **Exit Gracefully**: Provide actionable error messages

#### Resource Access Issues
- **Missing Resources**: Handle resources that don't exist
- **Permission Denied**: Gracefully handle insufficient permissions
- **API Timeouts**: Handle cluster API unavailability

### Command Line Interface

#### Usage Patterns
```bash
# Generate status report
./bin/monitor-health

# Show help
./bin/monitor-health --help
```

#### Help Information
- **Purpose Description**: Explain status report generation
- **Usage Instructions**: Show command syntax
- **Output Location**: Specify STATUS.md file creation

### Documentation Integration

#### Quick Commands Section
Must include these operational commands:
```bash
# Run health check
./bin/monitor-health

# Check ArgoCD applications
oc get application.argoproj.io -n openshift-gitops

# Check managed clusters
oc get managedcluster

# Check cluster provisioning
oc get clusterdeployment -A
oc get cluster.cluster.x-k8s.io -A
```

#### Context for Re-evaluation
- **Architecture Overview**: Hub cluster, managed clusters, GitOps flow
- **Component Descriptions**: Key components and their roles
- **Status Indicators**: Explanation of status symbols
- **Cross-references**: Links to detailed architecture documentation

### Performance Requirements

#### Efficient Resource Queries
- **Batch Operations**: Minimize individual API calls where possible
- **Conditional Checks**: Only query resources that exist
- **Timeout Handling**: Handle slow API responses gracefully

#### Output Generation
- **Incremental Writing**: Build STATUS.md progressively
- **Consistent Formatting**: Use heredoc for clean output generation
- **Timestamp Accuracy**: Include precise generation timestamp

### Dependencies

#### External Commands
- **oc**: OpenShift CLI for all cluster operations
- **find**: Discover cluster configuration files
- **grep**: Pattern matching for cluster names and status

#### File System Access
- **Write Permissions**: Must create/overwrite STATUS.md in root directory
- **Directory Navigation**: Access gitops-applications directory

#### Kubernetes Permissions
- **Cluster Admin Access**: Query all namespaces and cluster-wide resources
- **Application Access**: Read ArgoCD application status
- **ACM Access**: Read ManagedCluster and MultiClusterHub resources

## Related Tools

### Prerequisites
- **[bootstrap.md](./bootstrap.md)** - Must run before this tool to establish infrastructure
- **[bootstrap-vault-integration.md](./bootstrap-vault-integration.md)** - Must run before for complete status coverage

### Alternative Monitoring
- **[status.md](./status.md)** - Focused CRD establishment monitoring  
- **[wait-kube.md](./wait-kube.md)** - Specific resource readiness monitoring

### Workflow Integration
- **[update-dynamic-docs.md](./update-dynamic-docs.md)** - Uses health-check data for STATUS.md updates

## Design Principles

*This tool enables **operational visibility** - providing comprehensive, real-time status reporting for all components in the multi-cluster OpenShift Bootstrap environment.*