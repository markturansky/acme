#!/bin/bash

# Patch ArgoCD to allow Tekton Pipelines and PipelineRuns
# This script removes the default exclusions for Tekton resources in ArgoCD
# Usage: ./bin/patch-argocd-tekton

set -euo pipefail

echo "Patching ArgoCD to allow Tekton Pipelines and PipelineRuns..."

# Check if openshift-gitops namespace exists
if ! kubectl get namespace openshift-gitops &>/dev/null; then
    echo "Error: openshift-gitops namespace not found"
    exit 1
fi

# Patch the ArgoCD CR to exclude only TaskRuns and narrow ACM Secret exclusions
# This allows Pipeline, PipelineRun, and Task resources to be managed by ArgoCD
# Also allows ESO webhook secrets while excluding only ACM cluster application secrets
# Note: The ArgoCD operator manages the argocd-cm ConfigMap based on this CR
kubectl patch argocd openshift-gitops -n openshift-gitops --type merge -p '{
  "spec": {
    "resourceExclusions": "- apiGroups:\n  - tekton.dev\n  clusters:\n  - \"*\"\n  kinds:\n  - TaskRun\n- apiGroups:\n  - \"\"\n  clusters:\n  - \"*\"\n  kinds:\n  - Secret\n  jsonPointers:\n  - \"/metadata/labels/apps.open-cluster-management.io~1acm-cluster\"\n  name: \"*-application-manager-cluster-secret\""
  }
}'

echo "ArgoCD CR patched successfully"

# The ArgoCD operator will automatically update the ConfigMap
echo "Waiting for ConfigMap to be updated..."
sleep 5

# Verify the patch was applied
echo "Verifying resource exclusions..."
kubectl get configmap argocd-cm -n openshift-gitops -o jsonpath='{.data.resource\.exclusions}' | echo "Current exclusions:"
kubectl get configmap argocd-cm -n openshift-gitops -o jsonpath='{.data.resource\.exclusions}'
echo ""

echo "ArgoCD configuration updated successfully!"
echo ""
echo "Allowed Tekton resources:"
echo "  ✅ Pipeline (tekton.dev/Pipeline)"
echo "  ✅ PipelineRun (tekton.dev/PipelineRun)"
echo "  ✅ Task (tekton.dev/Task)"
echo ""
echo "Allowed Secrets:"
echo "  ✅ ESO webhook secrets (eso-external-secrets-webhook)"
echo "  ✅ All other non-ACM cluster secrets"
echo ""
echo "Still excluded:"
echo "  ❌ TaskRun (tekton.dev/TaskRun) - runtime resources managed by Tekton"
echo "  ❌ ACM cluster application secrets (*-application-manager-cluster-secret)"