# Bootstrap

This repository contains the scripting, configuration, GitOps content, and documentation necessary to bootstrap a region of a cloud service for Red Hat, based on OpenShift and the Red Hat products and supported community projects that we leverage in our reference architecture.

## Directory Structure

This repository follows a consistent navigation pattern across all deployment types:

### Base Templates
- `bases/clusters/` → OpenShift cluster base templates (ClusterDeployment, MachinePool, ManagedCluster)
- `bases/pipelines/` → Tekton pipeline base templates (Pipeline definitions)
- `bases/ocm/` → OCM service base templates (database services, secrets)

### Cluster-Specific Overlays
- `clusters/cluster-XX/` → Cluster provisioning overlays (OCP via Hive, EKS via CAPI)
- `pipelines/PIPELINE-NAME/cluster-XX/` → Pipeline deployment overlays (PipelineRuns per cluster per pipeline)
- `deployments/ocm/cluster-XX/` → OCM service deployment overlays (per cluster)

### Regional Specifications
- `regions/us-east-1/ocp-XX/` → Regional cluster specifications for generation
- `regions/us-east-1/eks-XX/` → Regional EKS cluster specifications

### GitOps Applications
- `gitops-applications/` → ArgoCD applications for automated deployment
  - `cluster-XX.cluster.yaml` → Cluster provisioning applications
  - `cluster-XX.pipelines.yaml` → Pipeline deployment applications
  - `cluster-XX.deployments.yaml` → OCM service deployment applications

**Navigation Pattern**: The repository uses a consistent hierarchy for intuitive navigation:

```bash
# Regional specifications (input for cluster generation)
ls regions/                    # Shows available regions (us-east-1, us-west-2, etc.)
ls regions/us-east-1/          # Shows cluster types (ocp-10, ocp-20, eks-40, etc.)

# Cluster provisioning (generated from regional specs)
ls clusters/                   # Shows all provisioned clusters (cluster-10, cluster-20, etc.)
ls clusters/cluster-10/        # Shows cluster manifests (namespace.yaml, install-config.yaml, etc.)

# Pipeline deployments (organized by pipeline type)
ls pipelines/                           # Shows pipeline types (hello-world, cloud-infrastructure-provisioning, etc.)
ls pipelines/hello-world/               # Shows clusters with hello-world pipelines (cluster-10, cluster-20, etc.)
ls pipelines/hello-world/cluster-10/    # Shows pipeline resources (kustomization.yaml, *.pipelinerun.yaml)

# Service deployments (organized by service type)
ls deployments/                # Shows deployment categories (ocm)
ls deployments/ocm/            # Shows clusters with OCM services (cluster-10, cluster-20, etc.)
ls deployments/ocm/cluster-10/ # Shows OCM deployment manifests (kustomization.yaml, namespace.yaml)
```

This structure enables consistent navigation where each level shows the next available options, making it easy to discover and manage resources across the entire infrastructure.  

# Install

## OpenShift

An initial OpenShift cluster is required to act as the bootstrap cluster and centralized/global control plane.

Obtaining or provisioning the bootstrap cluster is beyond the scope of this document, but the [example install-config.yaml](./examples/install-config.yaml)
was generated by the OpenShift installer to create an OCP cluster and is used as the basis for testing this project. 

The rest of this document assumes you are `kubeadmin` with a KUBECONFIG.


## Secrets

AWS accounts and image pull secrets are inputs into the provisioning process. They will be obtained by external
processes, stored in predictable vault paths, and delivered to our clusters.

Until there is Vault, we must create the `aws-credentials` and `pull-secret` Secrets for each cluster provisioned.

Currently, this project assumes the same credentials and pull secrets for all clusters.

From ACM, retrieve the `aws-credentials` and `pull-secret`, store them locally, and apply them to your cluster/namespace when needed.

```
# TODO: get the correct namespace for these secrets
oc get secret aws-credentials -n $cluster_namespace -o yaml > secrets/aws-credentials.yaml
oc get secret pull-secret -n $cluster_namespace -o yaml > secrets/pull-secret.yaml
```

# Clusters

Clusters are defined in this repository.  `cluster-10`, `region-02`, `region-02` are the examples.

The process for adding `cluster-40` is currently manual. Improvements to workflows and tooling around adding new
clusters is expected to continue.

To add `cluster-40`, do the following:

```
1. Copy/paste ./clusters/overlay/region-02 as ./clusters/overlay/region-04
2. Find/Replace 'cluster-10' with 'cluster-40' in the files in ./clusters/overlay/region-04
3. Add the new cluster overlay to ./regional-clusters/kustomization.yaml
4. Add the new cluster to the end of ./bootstrap.sh for observing status
5. Create a Pull Request and submit to the repository.
6. Run ./bootstrap.sh to wait for cluster-40 to be provisioned or watch the ACM console 
```

See https://github.com/openshift-online/bootstrap/pull/48

Argo applies the new cluster as part of the [regional clusters](./gitops-applications/regional-clusters.application.yaml) gitops application.


```mermaid
sequenceDiagram
   actor Admin
   actor Installer
   actor OCP
   actor Argo
   actor Git
   actor Tekton
   
   Admin->>Installer: Provision/Get Cluster
   Installer->>Admin: obtain KubeConfig
   
   Admin->>OCP: run ./bootstrap.sh
   OCP->>Admin: RHCP (ACM, Argo, Pipelines) is installed
      
   Argo->>Git: Get desired state
   Git->>Argo: Regional OCM YAML
   
   Argo->>OCP: Argo applies YAML
   OCP->>Argo: Deployment status
   
   Admin->>OCP: oc get pods 
   OCP->>Admin: Regional OCM is green 
    
```
