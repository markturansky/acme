# Cluster Monitoring & Status Guide

**Audience**: Operators  
**Complexity**: Beginner to Intermediate  
**Estimated Time**: 10 minutes to understand, ongoing monitoring  
**Prerequisites**: Access to hub cluster, basic kubectl knowledge

## Quick Status Check

```bash
# Get complete health overview
./bin/monitor-health

# Check ArgoCD applications
oc get application.argoproj.io -n openshift-gitops

# Check managed clusters
oc get managedcluster

# Check cluster provisioning
oc get clusterdeployment -A      # OCP clusters
oc get cluster.cluster.x-k8s.io -A  # EKS clusters
```

## Live Status Dashboard

### Current Cluster Status
**Last Updated:** Auto-generated by `bin/monitor-health` script

### Hub Cluster Status
- **ArgoCD GitOps**: ✅ Running (19 applications)
- **ACM MultiClusterHub**: ✅ Running
- **Total Managed Clusters**: 5 (3 available via ACM)

### Individual Cluster Status

#### ocp-02 (OCP, us-east-1)
- **Provisioning**: ⏳ Not Ready (Hive)
- **ACM Management**: ✅ Available
- **ArgoCD Apps**: 1/5 synced

#### ocp-03 (OCP, us-east-1)
- **Provisioning**: ⏳ Not Ready (Hive)
- **ACM Management**: ✅ Available
- **ArgoCD Apps**: 3/5 synced

#### ocp-04 (OCP, us-west-2)
- **Provisioning**: ⏳ Not Ready (Hive)
- **ACM Management**: ❌ Not Available (Unknown)
- **ArgoCD Apps**: 1/1 synced

#### eks-02 (EKS, ap-southeast-1)
- **Provisioning**: ⏳ Not Ready (CAPI)
- **ACM Management**: ❌ Not Available (Unknown)
- **ArgoCD Apps**: 0/1 synced

#### ocp-05 (OCP, eu-west-1)
- **Provisioning**: ⏳ Not Ready (Hive)
- **ACM Management**: ❌ Not Available (Unknown)
- **ArgoCD Apps**: 1/1 synced

## Monitoring Tools & Scripts

### 1. Health Check Script
```bash
./bin/monitor-health
```
**Purpose**: Comprehensive status overview of entire environment  
**Output**: Updates `STATUS.md` with current cluster states  
**Frequency**: Run on-demand or scheduled

### 2. CRD Establishment Monitor
```bash
./status.sh <crd-name> [timeout-in-seconds]
```
**Purpose**: Waits for Kubernetes CustomResourceDefinitions to be established  
**Default timeout**: 120 seconds  
**Check interval**: 5 seconds

**Examples**:
```bash
./status.sh applications.argoproj.io 300    # ArgoCD applications
./status.sh clusters.cluster.x-k8s.io 180   # CAPI clusters
./status.sh clusterdeployments.hive.openshift.io 180  # Hive deployments
```

### 3. Resource Condition Waiter
```bash
./wait.kube.sh <type> <name> <namespace> <jsonpath> <expected-value> [timeout]
```
**Purpose**: Waits for any Kubernetes resource to meet specific conditions  
**Default timeout**: 1800 seconds (30 minutes)  
**Check interval**: 60 seconds

**Examples**:
```bash
# Wait for ArgoCD server route
./wait.kube.sh route openshift-gitops-server openshift-gitops '{.kind}' Route

# Wait for ACM MultiClusterHub completion
./wait.kube.sh mch multiclusterhub open-cluster-management \
  '{.status.conditions[?(@.type=="Complete")].message}' "All hub components ready."

# Wait for OCP cluster provisioning
./wait.kube.sh clusterdeployment ocp-03 ocp-03 '{.status.webConsoleURL}' 

# Wait for EKS cluster provisioning
./wait.kube.sh awsmanagedcontrolplane eks-02 eks-02 '{.status.ready}' true
```

## Status Monitoring Workflows

### Daily Health Check
```bash
# 1. Run comprehensive health check
./bin/monitor-health

# 2. Check for failed applications
oc get application.argoproj.io -n openshift-gitops | grep -E "(OutOfSync|Unknown|Degraded)"

# 3. Check cluster provisioning status
oc get clusterdeployment -A --no-headers | awk '{print $1, $2, $7}'
oc get cluster.cluster.x-k8s.io -A --no-headers | awk '{print $1, $2, $5}'

# 4. Check managed cluster connectivity
oc get managedcluster --no-headers | awk '{print $1, $2}'
```

### Troubleshooting Workflow

#### ArgoCD Application Issues
```bash
# Check application status
oc get application [APP-NAME] -n openshift-gitops -o yaml

# Check application events
oc describe application [APP-NAME] -n openshift-gitops

# Check ArgoCD controller logs
oc logs -n openshift-gitops deployment/openshift-gitops-application-controller
```

#### Cluster Provisioning Issues
```bash
# For OCP clusters (Hive)
oc describe clusterdeployment [CLUSTER-NAME] -n [CLUSTER-NAME]
oc logs -n hive deployment/hive-controllers

# For EKS clusters (CAPI)
oc describe awsmanagedcontrolplane [CLUSTER-NAME] -n [CLUSTER-NAME]
oc logs -n capi-aws-system deployment/capa-controller-manager
```

#### ACM Management Issues
```bash
# Check managed cluster status
oc describe managedcluster [CLUSTER-NAME]

# Check klusterlet addon config
oc describe klusterletaddonconfig [CLUSTER-NAME] -n [CLUSTER-NAME]

# Check ACM hub logs
oc logs -n open-cluster-management deployment/multicluster-operators-hub-registration
```

## Status Indicators

### ✅ **Ready/Available**
- Component is operational and healthy
- Resources are created and functioning
- All conditions met

### ⏳ **Not Ready/Progressing**
- Component is provisioning or syncing
- In transition state, wait for completion
- Normal during deployment

### ❌ **Failed/Not Found**
- Component has issues or doesn't exist
- Requires intervention
- Check logs and troubleshoot

## Automated Monitoring

### Status File Updates
The `STATUS.md` file is automatically updated by `bin/monitor-health`:
- **Hub cluster status**: ArgoCD and ACM health
- **Individual clusters**: Provisioning, management, and application sync status
- **Summary metrics**: Total clusters, availability counts
- **Quick commands**: Common troubleshooting commands

### Monitoring Frequency
- **Production**: Run health check every 15 minutes
- **Development**: Run health check every hour
- **On-demand**: After any configuration changes

## Key Metrics to Monitor

### Hub Cluster Health
- ArgoCD server pod status
- ACM MultiClusterHub status
- Available cluster count vs. total

### Cluster Provisioning
- ClusterDeployment conditions (OCP)
- AWSManagedControlPlane status (EKS)
- Time to provision (< 45 minutes expected)

### GitOps Sync Status
- Application sync state
- Sync wave progression
- Failed sync count

### ACM Management
- ManagedCluster availability
- Klusterlet connectivity
- Policy compliance

## Alerting Thresholds

### Critical
- Hub cluster ArgoCD down
- ACM MultiClusterHub not ready
- Cluster provisioning failed > 1 hour

### Warning
- Application out-of-sync > 30 minutes
- ManagedCluster unknown > 15 minutes
- Cluster provisioning > 45 minutes

### Info
- New cluster provisioning started
- Application sync completed
- Health check completed

## Vault Status Monitoring

### Vault Server Health
```bash
# Check Vault pod status
oc get pods -n vault

# Check Vault server status
oc exec vault-0 -n vault -- vault status

# List stored secrets
oc exec vault-0 -n vault -- vault kv list secret/
```

### External Secrets Operator (ESO)
```bash
# Check ESO controller
oc get pods -n external-secrets

# Check ClusterSecretStore status
oc get clustersecretstore vault-cluster-store -o yaml

# Check ExternalSecret status across namespaces
oc get externalsecret -A
```

### Vault UI Access
```bash
# Port forward to Vault UI
oc port-forward -n vault vault-0 8200:8200

# Access: http://localhost:8200
# Token: root
```

## Related Documentation

- [Cluster Creation Guide](./cluster-creation.md) - Creating new clusters
- [Architecture Overview](../ARCHITECTURE.md) - System architecture
- [Installation Guide](../docs/getting-started/production-installation.md) - Initial setup
- [AWS Cleanup Guide](../bin/clean-aws.md) - Resource cleanup